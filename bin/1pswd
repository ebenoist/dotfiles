#!/usr/bin/env bash

TTL=$((20*60))
NOW=$(date +%s)
LAST_UPDATED=$(date +%s -r $HOME/.op-cache)
ELAPSED=$(($NOW - $LAST_UPDATED))

if [[ ! -f "$HOME/.op-cache" ]]; then
  echo "no-cache"
  op signin my > ~/.op-cache
elif [[ $ELAPSED -gt $TTL ]]; then
  echo "cache expired"
  op signin my > ~/.op-cache
else
  echo "logged in, will expire in $(($TTL - $ELAPSED)) seconds"
fi

eval $(cat ~/.op-cache)

LOGIN=$(op list items |\
  jq -C -c -r '.[] | {
    title: .overview.title,
    uuid,
    createdAt
  }' | fzf --ansi --preview="echo {} | jq -C ." | jq -r .uuid | op get item -)

echo $LOGIN | jq -c -r '.details.fields | .[] | { designation, value }' |\
  fzf --ansi --preview="echo {} | jq -C ." | jq -r .value | xclip -i -selection clipboard
